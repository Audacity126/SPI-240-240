# microPython驱动tft屏幕显示中文终极解决方案

## 一、运行效果

## 二、实现原理

原理同上篇文章一样，用在线汉字取模工具获取点阵的字节信息，通过st7789py.py驱动程序显示出来。

上次的程序只能显示部分汉字，需要显示哪些字自己去在线网站取模，然后存到程序里。不过像我这么懒的人，怎么可能一个一个取模啊。

我粗略一算gb2312不到8000个字符，对于16x16大小的汉字，每个汉字需要16*16bit，也就是32个字节，8000个字也就250k，这对于有4M flash的esp32简直绰绰有余啊。

想到是在浏览器上取模，浏览器能干的活python都能干，于是我写了一个爬虫程序，把七千多个汉字的点阵数据爬了下来。

[汉字取模网址](https://www.zhetao.com/fontarray.html)：https://www.zhetao.com/fontarray.html

爬虫代码：

```python
import struct
from selenium import webdriver
from selenium.webdriver.common.by import By


class lattice(object):
    def __init__(self, size):
        # size 为字体的大小
        options = webdriver.ChromeOptions()
        options.add_argument('User-Agent=Mozilla/4.0 (compatible; MSIE 7.0; Windows NT 6.0)')
        '''
        这里写Chrome浏览器地址和Chromedriver地址
        一般不用，可以删去
        我把chrome.exe改名了系统找不到，所以加上了地址
        '''
        options.binary_location = r'D:\Program Files\Google\Chrome\Application\chrom.exe'
        self.browser = webdriver.Chrome('D:\Program Files\Google\Chrome\Application\chromedriver.exe', options=options)

        self.url = 'https://www.zhetao.com/fontarray.html'
        self.size = size // 8

    def set_size(self):
        width = self.browser.find_element(by=By.XPATH, value='/html/body/div[1]/div[1]/input[1]')
        height = self.browser.find_element(by=By.XPATH, value='/html/body/div[1]/div[1]/input[2]')
        width.click()
        width.clear()
        width.send_keys(str(self.size))
        height.click()
        height.clear()
        height.send_keys(str(self.size * 8))

    def get_bytes(self, font):
        self.ele_font.clear()
        self.ele_font.send_keys(font)
        self.browser.find_element(by=By.XPATH, value='/html/body/div[1]/div[1]/input[7]').click()
        result = self.browser.find_element(by=By.XPATH, value='/html/body/div[1]/div[4]/div')
        bytes = result.text.split('{')[self.size + 1].split('}')[0].splitlines()
        r = b''
        t = ''
        for b in bytes:
            if len(b) > 1:
                b = b.strip(' ').split(',')
                for k in b:
                    if k:
                        # print(k.strip(' '))
                        r += int(k.strip(' ')[2:4], 16).to_bytes(1, 'big')
                        t += k.strip(' ')
        return r, t

    def b2i(self, byte):
        r = 0
        for i in range(len(byte)):
            r = (r << 8) + byte[i]
        return r

    def i2b(self, num):
        # num = int(num, 16)
        return num.to_bytes(3, 'big')

    def run(self):
        self.browser.get(self.url)
        self.ele_font = self.browser.find_element(by=By.XPATH,
                                                  value='/html/body/div[1]/div[1]/input[6]')
        self.set_size()
        font = []
        for i in range(0, 65535):
            hi_byte = i >> 8
            lo_byte = i & 0xff
            hz = struct.pack('<BB', hi_byte, lo_byte)
            # print(hz)
            # break

            try:
                hz: str = hz.decode(encoding='gb2312')  # 按GB2312解码
                if len(hz) == 1:
                    code_gb2312 = hz.encode(encoding='gb2312')
                    print(code_gb2312, '0x%04x' % (code_gb2312[0] * 256 + code_gb2312[1]), end=', ')
                    code_unicode = hz.encode(encoding='utf-8')
                    print('0x' + str(code_unicode)[:-1], end=', ')
                    print('// ' + hz, (self.b2i(code_gb2312) - 41448 + 67) * 128)
                    if self.b2i(code_unicode) > 14844052:
                        try:
                            bytes, txt = self.get_bytes(code_unicode.decode('utf-8'))
                            font.append((self.b2i(code_unicode), bytes))
                        except:
                            print('error')
                    # time.sleep(0.5)
            except:
                pass
        # 按编码排序，以便使用二分查找
        font.sort(key=lambda x: x[0])
        t = open(f'gb{self.size * 8}x{self.size * 8}.ttf', 'wb')
        for f in font:
            t.write(self.i2b(f[0]))
            t.write(f[1])
        print(len(font))
        t.close()
        self.browser.close()

    def __del__(self):
        pass


if __name__ == '__main__':
    # 括号里填写字体大小
    # 必须为8的倍数，如16,24,32
    l = lattice(16)
    l.run()

```

数据爬下来了，但是应该怎样存储呢，microPython里只支持utf-8编码，而utf-8和gbk编码里汉字的储存码是不连续的，用散列表映射会有很多浪费空间，我试了一下，原本只有250k的数据，用gbk编码散列映射需要691k，用utf-8映射可能需要再翻很多倍，散列表映射虽然查找比较快，但是很费空间。

于是，我选择用时间换空间，把汉字数据按utf-8编码排序，顺序储存，最后采用二分法查找汉字的点阵数据。

.ttf文件数据存储格式 utf-8码+点阵数据，所以对于每个汉字，所需要的数据在原来点阵数据的基础上又加了3个字节的utf-8编码

例如：16x16大小的'周'

```python
'\xe5\x91\xa8'   "\x00\x00?\xf8!\x08!\x08/\xe8!\x08!\x08?\xf8 \x08'\xc8$H$H'\xc8@\x08@(\x80\x10"
```

## 三、字体

数据储存完了，接下来就是查找

代码如下（**数据存在esp32的package文件夹里**）：

```python
class Font:
    def __init__(self,size):
        self.WIDTH = size
        self.HEIGHT = size
        self.SIZE = size * (size // 8)
        self.FONT = {}
    
class gb2312(object):
    def __init__(self,size):
        self.f = open('./package/gb{0}x{0}.ttf'.format(size), 'rb')
        self.height = size
        self.size = size * (size // 8) + 3
    def b2i(self, byte):
        r = 0
        for i in range(len(byte)):
            r = (r << 8) + byte[i]
        return r

    def i2b(self, num):
        return num.to_bytes(3, 'big')

    def one_char(self, char):
        utf_byte = char.encode('utf-8')
        return self.B_S(0, 7296, self.b2i(utf_byte))
    
    def str(self,st):
        font = Font(self.height)
        for s in st:
            data = self.one_char(s) 
            font.FONT[s] = data if data else self.one_char('一')
        return font
    def B_S(self, low, high, m):
        if low >= 0 and high <= 7296 and low <= high:
            mid = (low + high) // 2
            self.f.seek(mid * self.size)
            data = self.f.read(self.size)
            utf = self.b2i(data[0:3])
            if utf < m:
                return self.B_S(mid + 1, high, m)
            elif utf > m:
                return self.B_S(low, mid - 1, m)
            else:
                return data[3:]
    def __del__(self):
        self.f.close()

if __name__ == '__main__':
    F = gb2312(24)
    char = F.one_char('周')
    t = F.str('你好！世界')
    print(t.HEIGHT,t.FONT)
```

那么我想自定义其他字号的字体怎么办？

终极解决办法

```python
class Font:
    def __init__(self, size):
        self.WIDTH = size
        self.HEIGHT = size
        self.SIZE = size * (size // 8)


class Font32(Font):
    def __init__(self,size):
        Font.__init__(self,size)
        '''
        想要哪个汉字，自己往后加
        '''
        self.FONT = {
        '℃': [0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0f,
              0x80, 0x00, 0x00, 0x1f, 0xc3, 0xff, 0x00, 0x1d, 0xc7, 0xff, 0xb0, 0x1d, 0xcf, 0x83, 0xf0, 0x1d, 0xde,
              0x00, 0xf0, 0x1f, 0xfc, 0x00, 0x70, 0x07, 0x3c, 0x00, 0x70, 0x00, 0x78, 0x00, 0x30, 0x00, 0x78, 0x00,
              0x30, 0x00, 0x78, 0x00, 0x30, 0x00, 0x78, 0x00, 0x00, 0x00, 0x78, 0x00, 0x00, 0x00, 0x78, 0x00, 0x00,
              0x00, 0x78, 0x00, 0x00, 0x00, 0x78, 0x00, 0x00, 0x00, 0x78, 0x00, 0x00, 0x00, 0x78, 0x00, 0x00, 0x00,
              0x3c, 0x00, 0x00, 0x00, 0x3c, 0x00, 0x30, 0x00, 0x3e, 0x00, 0x70, 0x00, 0x1f, 0x01, 0xe0, 0x00, 0x0f,
              0x87, 0xc0, 0x00, 0x07, 0xff, 0x80, 0x00, 0x03, 0xfe, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
              0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00],
        '晴': [0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1c, 0x00, 0x00, 0x00, 0x1e, 0x30, 0x00,
              0x00, 0x1c, 0x78, 0x38, 0xff, 0xff, 0xfc, 0x3f, 0xfc, 0x1c, 0x00, 0x38, 0xf0, 0x1c, 0x00, 0x38, 0xe0,
              0x1c, 0xf0, 0x38, 0xe7, 0xff, 0xf8, 0x38, 0xe3, 0x1c, 0x00, 0x38, 0xe0, 0x1c, 0x18, 0x38, 0xe0, 0x1c,
              0x3c, 0x38, 0xff, 0xff, 0xfe, 0x3f, 0xfc, 0x00, 0x00, 0x38, 0xe7, 0x00, 0xf0, 0x38, 0xe3, 0xff, 0xf0,
              0x38, 0xe3, 0x80, 0xf0, 0x38, 0xe3, 0x80, 0xe0, 0x38, 0xe3, 0xff, 0xe0, 0x38, 0xe3, 0x80, 0xe0, 0x38,
              0xe3, 0x80, 0xe0, 0x3f, 0xe3, 0x80, 0xe0, 0x38, 0xe3, 0xff, 0xe0, 0x38, 0xe3, 0x80, 0xe0, 0x38, 0xe3,
              0x80, 0xe0, 0x30, 0x03, 0x80, 0xe0, 0x00, 0x03, 0x80, 0xe0, 0x00, 0x03, 0x8f, 0xe0, 0x00, 0x03, 0x87,
              0xe0, 0x00, 0x07, 0x01, 0xe0, 0x00, 0x00, 0x00, 0x00],
        '雨': [0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x38, 0x00,
              0x00, 0x00, 0x78, 0x3f, 0xff, 0xff, 0xfc, 0x1c, 0x03, 0x80, 0x00, 0x00, 0x03, 0x80, 0x00, 0x00, 0x03,
              0x80, 0x00, 0x0e, 0x03, 0x80, 0xf0, 0x0f, 0xff, 0xff, 0xf8, 0x0e, 0x03, 0x80, 0xf0, 0x0f, 0xc3, 0xa0,
              0xf0, 0x0f, 0xf3, 0xf8, 0xf0, 0x0e, 0xfb, 0xbe, 0xf0, 0x0e, 0x7f, 0x9e, 0xf0, 0x0e, 0x3f, 0x8e, 0xf0,
              0x0e, 0x3b, 0x8e, 0xf0, 0x0e, 0x1b, 0x86, 0xf0, 0x0f, 0x83, 0x80, 0xf0, 0x0f, 0xe3, 0xf8, 0xf0, 0x0e,
              0xfb, 0xbe, 0xf0, 0x0e, 0x7b, 0x9e, 0xf0, 0x0e, 0x3b, 0x8f, 0xf0, 0x0e, 0x3b, 0x8f, 0xf0, 0x0e, 0x1b,
              0x86, 0xf0, 0x0e, 0x03, 0x80, 0xf0, 0x0e, 0x03, 0x9f, 0xf0, 0x0e, 0x03, 0x9f, 0xe0, 0x0e, 0x03, 0x83,
              0xe0, 0x0e, 0x03, 0x01, 0xc0, 0x00, 0x00, 0x00, 0x00],
        '雾': [0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x07, 0x80, 0x03, 0xff, 0xff, 0xc0, 0x01,
              0xc3, 0xc0, 0x00, 0x06, 0x03, 0xc0, 0x38, 0x0f, 0xff, 0xff, 0xfc, 0x0e, 0x03, 0xc0, 0x7c, 0x1f, 0xff,
              0xff, 0xf0, 0x3e, 0x03, 0xc0, 0xe0, 0x19, 0xff, 0xff, 0x80, 0x00, 0x03, 0xc0, 0x00, 0x00, 0x3b, 0x80,
              0x00, 0x00, 0x7c, 0x0f, 0x00, 0x00, 0xff, 0xff, 0x80, 0x01, 0xf8, 0x1f, 0x80, 0x03, 0xdc, 0x3c, 0x00,
              0x0f, 0x0f, 0xf0, 0x00, 0x0e, 0x07, 0xf0, 0x00, 0x00, 0x3f, 0xff, 0xfe, 0x01, 0xff, 0x3f, 0xfe, 0x1f,
              0xe7, 0x87, 0xf8, 0x7c, 0x07, 0x83, 0x80, 0x03, 0xff, 0xff, 0xc0, 0x01, 0xcf, 0x03, 0x80, 0x00, 0x0f,
              0x07, 0x80, 0x00, 0x1e, 0x07, 0x00, 0x00, 0x3c, 0x07, 0x00, 0x00, 0xf8, 0xff, 0x00, 0x07, 0xe0, 0x7e,
              0x00, 0x3f, 0x00, 0x3e, 0x00, 0x00, 0x00, 0x00, 0x00],
        '': [],
        '': [],
    }
class Font48(Font):
    def __init__(self,size):
        Font.__init__(self,size)
        '''
        这个是显示的半角英文字符，所以字体宽度和size都需要单独设置
        '''
        self.WIDTH = 24
        self.SIZE = 144
        self.FONT = {
            '1': [0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x1c, 0x00, 0x00, 0xfc, 0x00, 0x07,
                  0xfc, 0x00, 0x07, 0xfc, 0x00, 0x00, 0x3c, 0x00, 0x00, 0x3c, 0x00, 0x00, 0x3c, 0x00, 0x00, 0x3c, 0x00,
                  0x00, 0x3c, 0x00, 0x00, 0x3c, 0x00, 0x00, 0x3c, 0x00, 0x00, 0x3c, 0x00, 0x00, 0x3c, 0x00, 0x00, 0x3c,
                  0x00, 0x00, 0x3c, 0x00, 0x00, 0x3c, 0x00, 0x00, 0x3c, 0x00, 0x00, 0x3c, 0x00, 0x00, 0x3c, 0x00, 0x00,
                  0x3c, 0x00, 0x00, 0x3c, 0x00, 0x00, 0x3c, 0x00, 0x00, 0x3c, 0x00, 0x00, 0x3c, 0x00, 0x00, 0x3c, 0x00,
                  0x00, 0x3c, 0x00, 0x00, 0x3c, 0x00, 0x00, 0x3c, 0x00, 0x00, 0x3e, 0x00, 0x00, 0x7e, 0x00, 0x07, 0xff,
                  0xf0, 0x07, 0xff, 0xf0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00],
            '2': [0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0xff, 0x80, 0x07, 0xff, 0xe0, 0x0f, 0x83, 0xf0, 0x1f,
                  0x01, 0xf0, 0x1e, 0x00, 0xf8, 0x1e, 0x00, 0xf8, 0x3e, 0x00, 0xf8, 0x3f, 0x00, 0x78, 0x3f, 0x00, 0x78,
                  0x3f, 0x00, 0x78, 0x1f, 0x00, 0xf8, 0x00, 0x00, 0xf8, 0x00, 0x00, 0xf8, 0x00, 0x01, 0xf0, 0x00, 0x03,
                  0xf0, 0x00, 0x03, 0xe0, 0x00, 0x07, 0xc0, 0x00, 0x0f, 0x80, 0x00, 0x1f, 0x00, 0x00, 0x3e, 0x00, 0x00,
                  0x7c, 0x00, 0x00, 0xf8, 0x00, 0x01, 0xf0, 0x00, 0x03, 0xe0, 0x00, 0x03, 0xc0, 0x00, 0x07, 0x80, 0x1c,
                  0x0f, 0x00, 0x1c, 0x1f, 0x00, 0x38, 0x3e, 0x00, 0x38, 0x3c, 0x00, 0xf8, 0x3f, 0xff, 0xf8, 0x3f, 0xff,
                  0xf8, 0x3f, 0xff, 0xf8, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00],
        }
if __name__ == '__main__':
    f32 = Font32(32)
    f48 = Font48(48)
    print(f32.SIZE)
    print(f48.WIDTH)
```

